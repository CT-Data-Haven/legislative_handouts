---
output: 
  pdf_document: 
    latex_engine: xelatex
header-includes: 
  \usepackage{fancyhdr}
  \pagestyle{fancy}
  \fancyhf{ }
  \chead{1/2018}
  \rfoot{\includegraphics[height=0.2in]{DataHaven_Black.png}}
  \pagenumbering{gobble}
mainfont: OpenSans
params:
  this_id: "610U500US09010"
---

---
title: Connecticut State Legislative Profile, 2016
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = F,
	message = FALSE,
	warning = FALSE
)
options(knitr.table.format = "latex")
```

```{r}
setwd("~/_R/legislators/handout")
library(tidyverse)
library(extrafont)
library(rgdal)
library(rgeos)
library(ggmap)
library(broom)
library(kableExtra)
library(scales)
library(knitr)
library(rcartocolor)
library(RColorBrewer)
# library(rJava)
# library(OpenStreetMap)
```

```{r}
# will set by params
# this_id <- "610U500US09008"
this_id <- params$this_id
chamber <- ifelse(str_detect(this_id, "^610U5"), "Senate", "House")
num <- str_sub(this_id, -3) %>% as.integer()
name <- sprintf("State %s District %s", chamber, num)
```


```{r}
prof_df <- read_csv("../legislative_data_clean.csv") %>% select(-type, -format)
towns <- read_csv("../town_x_district.csv")
meta <- read_csv("./meta_tmp.csv") %>% mutate(order = row_number()) %>% separate(indicator, into = c("type", "ind2"), sep = 1)
reps <- read_csv("../legis_names.csv")

df <- prof_df %>% filter(id == this_id | chamber == "State") 
# town_list <- towns %>% filter(id == this_id) %>% pull("town") %>% paste(collapse = ", ")
town_list <- towns %>% filter(id == this_id) %>% pull("town")
rep <- reps %>% filter(id == this_id) %>% pull("string")
```




```{r}
df2 <- df %>%
	mutate(indicator = case_when(
		str_detect(indicator, "(pop|stat)") ~ paste0("n", indicator),
		topic %in% c("civic", "econ", "health") ~ paste0("p", indicator),
		indicator %in% c("hh", "inc") ~ paste0("n", indicator),
		T ~ indicator
	)) %>%
	separate(indicator, into = c("type", "ind2"), sep = 1) %>%
	select(-id) %>%
	spread(key = chamber, value = value, sep = "_") %>%
	split(.$type) %>%
	imap(function(df, i) df %>% select(-type) %>% setNames(c("topic", "ind2", paste(i, "District", sep = "_"), paste(i, "State", sep = "_")))) %>%
	reduce(full_join, by = c("topic", "ind2")) %>%
	mutate(topic2 = as.factor(topic) %>% fct_collapse(basic = c("age", "race", "immigration"), cws = c("civic", "econ", "health"), income = c("income", "income_kids", "income_seniors")))

pop <- df2 %>% filter(ind2 == "pop_age") %>% pull("n_District")
hh <- df2 %>% filter(ind2 == "hh") %>% pull("n_District")

tbls <- meta %>%
	filter(type == "n" | topic %in% c("civic", "econ", "health")) %>%
	select(displayIndicator, ind2, order) %>%
	inner_join(df2, by = "ind2") %>%
	select(-ind2, -topic) %>%
	rename(topic = topic2, Indicator = displayIndicator) %>%
	split(.$topic) %>%
	map(~arrange(., order))
```

See interactive maps and data for all state Senate and House districts: https://ct-data-haven.github.io/legis2016/

# `r name`

* Represented by `r rep`
* Covers all or parts of `r town_list`
* Total population: `r comma(pop)` (`r comma(hh)` households)

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# shapes
dist_shps <- list(
	Senate = readOGR("../../reference/cb_2016_09_sldu_500k", "cb_2016_09_sldu_500k", verbose = F),
	House = readOGR("../../reference/cb_2016_09_sldl_500k", "cb_2016_09_sldl_500k", verbose = F)
)
states <- tigris::states(cb = T)
ct_shp <- subset(states, STUSPS == "CT")
town_shp <- readOGR("../../reference/town_shp", "cb_2015_09_cousub_500k", verbose = F)
ct_tidy <- tidy(ct_shp)
dist_shp <- dist_shps[[chamber]] %>% subset(AFFGEOID == this_id)
dist_tidy <- tidy(dist_shp, region = "AFFGEOID")
town_tidy <- town_shp %>% subset(NAME %in% town_list) %>% tidy(region = "NAME")
bbox1 <- make_bbox(ct_tidy$long, ct_tidy$lat)
bbox2 <- make_bbox(dist_tidy$long, dist_tidy$lat)

center1 <- c(mean(c(bbox1[["left"]], bbox1[["right"]])), mean(c(bbox1[["top"]], bbox1[["bottom"]])))
center2 <- c(mean(c(bbox2[["left"]], bbox2[["right"]])), mean(c(bbox2[["top"]], bbox2[["bottom"]])))
```

```{r message=FALSE, warning=FALSE}
# basemap1 <- get_map(bbox1, source = "google", maptype = "roadmap", force = F)
# basemap2 <- get_map(bbox2, source = "google", maptype = "roadmap", force = F)
ct_style <- "&style=element:labels%7Cvisibility:off&style=feature:administrative.land_parcel%7Cvisibility:off&style=feature:administrative.neighborhood%7Cvisibility:off&style=feature:road%7Cvisibility:off"
zoom_style <- "&style=element:labels.text%7Ccolor:0x5e5e5e%7Cvisibility:on%7Cweight:0.5&style=feature:administrative.land_parcel%7Cvisibility:off&style=feature:administrative.locality%7Celement:geometry.stroke%7Ccolor:0x212121&style=feature:administrative.locality%7Celement:labels%7Cvisibility:simplified&style=feature:administrative.neighborhood%7Cvisibility:off&style=feature:poi.business%7Cvisibility:off&style=feature:poi.park%7Celement:labels.text%7Cvisibility:off&style=feature:road%7Celement:labels%7Cvisibility:off&style=feature:road.arterial%7Celement:geometry%7Cvisibility:simplified&style=feature:road.arterial%7Celement:labels%7Cvisibility:off&style=feature:road.highway%7Celement:geometry.fill%7Cvisibility:on&style=feature:road.highway%7Celement:geometry.stroke%7Cvisibility:off&style=feature:road.highway%7Celement:labels%7Cvisibility:off&style=feature:road.local%7Cvisibility:off&style=feature:water%7Celement:geometry.fill%7Ccolor:0xaadded%7Cvisibility:on&style=feature:water%7Celement:labels.text%7Cvisibility:off"

# basemap1 <- get_googlemap(center1, source = "google", maptype = "roadmap", inject = ct_style, zoom = 9)
# basemap2 <- get_googlemap(center2, source = "google", maptype = "roadmap", inject = zoom_style, zoom = 12)
basemap1 <- get_map(bbox1, source = "stamen", maptype = "toner-lite", force = F)
basemap2 <- get_map(bbox2, source = "stamen", maptype = "toner-lite", force = F)
```

```{r}
ct_map <- ggmap(basemap1, extent = "device", darken = c(0.4, "white")) +
	geom_path(aes(x = long, y = lat, group = group), data = ct_tidy, color = "#999999") +
	geom_polygon(aes(x = long, y = lat, group = group), data = dist_tidy, fill = "maroon", alpha = 0.7) + 
	theme(plot.margin = unit(c(0, 0.25, 0, 0), "in"))
```


```{r}
zoom_map <- ggmap(basemap2, extent = "device", darken = c(0.4, "white")) +
	geom_path(aes(x = long, y = lat, group = group), data = dist_tidy, color = "maroon", size = 1) 
```

```{r}
# map_theme <- theme_minimal() %+replace% theme(plot.margin = unit(rep(0.5, 4), "in"))
cowplot::plot_grid(ct_map, zoom_map, nrow = 1)
```


## Demographics

```{r}
percent2 <- function(x) {
	sapply(x, function(n) {
		ifelse(is.na(n), "", round(n * 100) %>% cell_spec(align = "r"))
	})
}

comma2 <- function(x) {
	sapply(x, function(n) {
		ifelse(is.na(n), "", comma(n) %>% cell_spec(align = "r"))
	})
}
```


```{r}
tbls$basic %>%
	select(Indicator, n_District, p_District, n_State, p_State) %>%
	setNames(c("Indicator", "Number", "Percentage", "Number ", "Percentage ")) %>%
	mutate_at(vars(3, 5), percent2) %>%
	mutate_at(vars(2, 4), comma2)  %>%
	kable(booktabs = T, escape = F) %>%
	kable_styling(font_size = 8, position = "left") %>%
	group_rows("Age", 2, 3) %>%
	group_rows("Race and ethnicity", 4, 7) %>%
	group_rows("Immigration", 8, 8) %>%
	add_header_above(c(" " = 1, "District" = 2, "Connecticut" = 2)) %>%
	kableExtra::footnote(general = "US Census Bureau. American Community Survey 2016 5-year estimates.", general_title = "Source: ", footnote_as_chunk = T)
```

## Households and Income

```{r}
bind_rows(tbls$households %>% slice(-4), tbls$income %>% slice(c(1:4, 11))) %>%
	select(Indicator, n_District, p_District, n_State, p_State) %>%
	setNames(c("Indicator", "Number", "Percentage", "Number ", "Percentage ")) %>%
	mutate_at(vars(3, 5), percent2) %>%
	mutate_at(vars(2, 4), comma2)  %>%
	kable(booktabs = T, escape = F) %>%
	kable_styling(font_size = 8, position = "left") %>%
	group_rows("Household resources", 2, 3) %>%
	group_rows("Income and poverty", 4, 8) %>%
	add_header_above(c(" " = 1, "District" = 2, "Connecticut" = 2)) %>%
	kableExtra::footnote(general = "US Census Bureau. American Community Survey 2016 5-year estimates.", general_title = "Source: ", footnote_as_chunk = T)

```

```{r, results="asis"}
if(chamber == "Senate") {
	cat("## Community Wellbeing")
}
```

```{r}
# want to filter so only shows if chamber == Senate
if(chamber == "Senate") {
	tbls$cws %>%
		slice(c(3:4, 7:9)) %>%
		select(Indicator, p_District, p_State) %>%
		setNames(c("Indicator", "Percentage", "Percentage ")) %>%
		mutate_at(vars(2, 3), percent2) %>%
		kable(booktabs = T, escape = F) %>%
		kable_styling(font_size = 8, position = "left") %>%
		group_rows("Civic vitality", 1, 3) %>%
		group_rows("Financial security", 4, 5) %>%
		add_header_above(c(" " = 1, "District" = 1, "Connecticut" = 1)) %>%
		kableExtra::footnote(general = "2015 DataHaven Community Wellbeing Survey.", general_title = "Source: ", footnote_as_chunk = T)
}
```



